# Задачи плагина

## [PLUGIN] Индикатор статуса задачи в UI

**Статус:** todo

**Цель:** добавить в `plugin/ui.html` панель статуса, которая после вызова Fetch подписывается на SSE `/tasks/:id/watch` и показывает статус/логи в реальном времени.

**Изменяемые файлы:**
- `plugin/ui.html`
- `plugin/code.js`
- при необходимости вспомогательные модули в `plugin/`

**Критерии приёмки (Acceptance):**
- Подписка стартует после Fetch, когда известен `taskId`, и корректно отписывается при закрытии плагина.
- Сетевые ошибки отображаются в панели и не ломают UI.
- Статусы и логи обновляются в реальном времени по событиям SSE.

**Smoke-тест:**
1. Создать задачу через UI или curl.
2. Нажать Fetch в плагине и увидеть статусы по мере получения логов/результата.
3. Проверить, что при закрытии/открытии плагина подписка пересоздаётся без ошибок.

## [PLUGIN] Artifacts Gallery (поиск, пагинация, массовое скачивание)

**Статус:** todo

**Цель:** во вкладке `Artifacts` в `plugin/ui.html` показать список артефактов с управлением порядком/лимитом, локальным поиском по ID и массовой выгрузкой.

**Сценарии UX:**
- Пользователь открывает вкладку Artifacts и видит таблицу с колонками ID, CreatedAt, Size, JSON, ZIP и чекбоксами.
- Поле Search by ID фильтрует текущую страницу по подстроке без дополнительных запросов.
- Переключатель Order и поле Limit обновляют данные через `/artifacts?offset=…&limit=…&order=…`.
- Кнопки Prev/Next меняют offset и подгружают следующую/предыдущую страницу.
- Кнопка Download selected as ZIP отправляет `POST /artifacts/bulk.zip` с выбранными ID и сохраняет архив с подпапками `{id}/` и файлами `exportSpec.json`, `logs.txt`, `task.json`, `meta.json`.

## [PLUGIN] Artifact details & Re-run

**Статус:** done

**UX-сценарий:**
- Пользователь кликает строку в таблице Artifacts и справа открывается панель деталей без перезагрузки списка.
- В шапке панели отображаются `Task ID`, `Created`, `Status`, а также кнопки `Download JSON`, `Download ZIP`, `Copy Task ID` и `Re-run task`.
- Блок `Logs` показывает историю событий построчно; `Copy Task ID` моментально кладёт идентификатор в буфер обмена.
- Блок `ExportSpec` содержит сворачиваемый просмотр JSON с поиском по значениям и кнопкой `Copy JSON`.
- Кнопка `Re-run task` отправляет исходный `taskSpec` в `POST /tasks`, добавляя к `meta.id` суффикс `-rerun-<short_ts>` и поле `meta.rerunOf` с исходным идентификатором. После успешного ответа выводится уведомление с новым `taskId` и быстрыми действиями «Watch status» и «Load in Builder».
- Панель закрывается по нажатию на фон, кнопку × или клавишу `Esc`; пагинация и фильтры таблицы не сбрасываются.
- Для шаринга с коллегами в блоке действий есть кнопки `Share JSON` и `Share ZIP`. Они вызывают `POST /tasks/{id}/share` и показывают одноразовую ссылку с TTL, плюс кнопку для копирования URL.

## [PLUGIN] Artifact previews (M16)

**Статус:** todo

- После успешного `Export` основной процесс плагина пытается экспортировать выбранный фрейм в PNG (`exportAsync`) и отправляет превью на Relay (`POST /tasks/{id}/preview`) отдельным запросом. Ошибки загрузки не должны ломать основной флоу экспорта.
- Во вкладке `Artifacts` у записей с `hasPreview=true` отображается миниатюра (PNG). По клику на строку открывается панель деталей с полноразмерным превью (fit-to-width) и кнопкой `Download preview`.
- При открытии деталей превью загружается по `previewUrl` (учитывая API key) и обновляется после повторной отправки.

## API key для плагина

- В `plugin/ui.html` есть поле “API key” под textarea. Значение хранится в `localStorage` (ключ `relay:api-key`) и не покидает устройство.
- Все запросы из UI используют helper `relayFetch(...)`, который автоматически добавляет заголовки `Authorization: Bearer <key>` и `X-API-Key`.
- Ссылки на артефакты (JSON/ZIP, bulk ZIP, детали артефактов) дополняются `?apiKey=<key>`, чтобы скачивание из браузера проходило без ручного ввода заголовков.
- Для SSE `/tasks/{id}/watch` ключ добавляется в query-string; при изменении ключа активная подписка переподключается.

## Export diff as HTML

- Во вкладке Compare появилась кнопка «Export diff as HTML». Она активируется после выбора двух артефактов и загрузки результатов сравнения.
- Кнопка открывает новый таб с `GET /artifacts/compare.html?leftId=…&rightId=…&mode=full`; API key автоматически подставляется в query string.
- HTML-страница показывает Summary/Changes, якоря по путям и внизу кнопку «Download JSON diff» для того же набора параметров.

## Download diff.zip

- В панели Compare рядом с HTML-экспортом есть кнопка «Download diff.zip». Она становится активной после загрузки diff.
- Кнопка вызывает `GET /artifacts/compare.zip` с текущими `leftId/rightId` (и `mode=full`) и учитывает сохранённый API key.
- Архив содержит `diff.json`, `diff.html` и `meta.txt` — можно делиться офлайн-отчётом.

## Visual compare

- Если у обоих выбранных артефактов есть превью, появляется блок Visual compare.
- Режимы: Side-by-side (две картинки) и Overlay slider (ползунок для наложения). Переключатель и слайдер обновляют только визуальный блок.
- Превью автоматически подтягиваются с Relay с учётом API key и кэш-версии.
